# Skills System Documentation

## Overview

The Skills system represents knowledge and expertise that players acquire through training and practice. Skills progress through experience gained by using the skill, performing related actions, or engaging in specific activities. Each skill has a maximum cap and provides bonuses when used, creating a deep progression system that rewards specialization and practice.

## Key Features

- **24 Skills**: Comprehensive skill system covering combat, magic, gathering, crafting, and special skills
- **Experience-Based Progression**: Skills level up through experience gained from use
- **Skill Caps**: Maximum level limits for each skill (typically 100, can be increased)
- **Stat Integration**: Skills can grant stat experience to primary/secondary stats
- **Skill Bonuses**: Higher skill levels provide bonuses to related actions
- **Progressive Difficulty**: Skill progression becomes slower at higher levels
- **Stat Point Rewards**: Leveling skills can grant stat points

## Skill Categories

### Combat Skills

**1. Combat With Weapons (CombatWithWeapons)**
- **Description**: Proficiency with one-handed melee weapons
- **Weapons**: Axe, Dagger, Sword, Hammer
- **Primary Stat**: Strength
- **Secondary Stat**: Dexterity
- **Progression**: Gain XP by attacking with one-handed weapons
- **Bonus**: Increases damage and accuracy with one-handed weapons

**2. Long Range Weapons (LongRangeWeapons)**
- **Description**: Proficiency with ranged weapons
- **Weapons**: Bow, Crossbow
- **Primary Stat**: Dexterity
- **Secondary Stat**: Strength
- **Progression**: Gain XP by attacking with ranged weapons
- **Bonus**: Increases damage, accuracy, and range with ranged weapons

**3. Two Handed Weapons (TwoHandedWeapons)**
- **Description**: Proficiency with two-handed weapons
- **Weapons**: Two-Handed Axe, Two-Handed Sword, Two-Handed Hammer, Spear, Staff
- **Primary Stat**: Strength
- **Secondary Stat**: Dexterity
- **Progression**: Gain XP by attacking with two-handed weapons
- **Bonus**: Increases damage and effectiveness with two-handed weapons

**4. Unarmed Combat (Luta Sem Armas)**
- **Description**: Proficiency in hand-to-hand combat
- **Primary Stat**: Strength
- **Secondary Stat**: Dexterity
- **Progression**: Gain XP by attacking without weapons
- **Bonus**: Increases unarmed damage and combat effectiveness

### Magic Skills

**5. Elementarism (Elementarism)**
- **Description**: Mastery of elemental magic (Fire, Cold, Energy, Light)
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by casting elemental spells
- **Bonus**: Increases elemental spell damage and effectiveness

**6. Necromancy (Necromancy)**
- **Description**: Mastery of dark magic and death magic
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by casting necromancy spells
- **Bonus**: Increases necromancy spell damage and effectiveness

**7. Druidism (Druidy)**
- **Description**: Mastery of nature magic and healing
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by casting druid spells
- **Bonus**: Increases druid spell effectiveness and healing power

**8. Spirituality (Spirituality)**
- **Description**: Mastery of spiritual and divine magic
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by casting spirituality spells
- **Bonus**: Increases spiritual spell effectiveness

**9. Invocation (Invocation)**
- **Description**: Mastery of summoning and conjuration magic
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by summoning creatures
- **Bonus**: Increases summon effectiveness and duration

**10. Magic Resistance (MagicResistence)**
- **Description**: Resistance to magical damage
- **Primary Stat**: Intelligence
- **Secondary Stat**: Constitution
- **Progression**: Gain XP by taking magical damage
- **Bonus**: Reduces incoming magical damage

### Gathering Skills

**11. Mining (Mining)**
- **Description**: Ability to extract ores and minerals
- **Primary Stat**: Strength
- **Secondary Stat**: Dexterity
- **Progression**: Gain XP by mining ore nodes
- **Bonus**: Increases mining speed and rare material chance
- **Tools**: Pickaxe

**12. Herbalism (Herbalism)**
- **Description**: Ability to gather herbs and plants
- **Primary Stat**: Intelligence
- **Secondary Stat**: Luck
- **Progression**: Gain XP by gathering herbs
- **Bonus**: Increases gathering speed and rare herb chance

**13. Skinning (Skinning)**
- **Description**: Ability to skin animals for hides and materials
- **Primary Stat**: Dexterity
- **Secondary Stat**: Luck
- **Progression**: Gain XP by skinning dead creatures
- **Bonus**: Increases skinning speed and rare material chance
- **Tools**: Knife

**14. Fishing (Fishing)**
- **Description**: Ability to catch fish
- **Primary Stat**: Dexterity
- **Secondary Stat**: Luck
- **Progression**: Gain XP by fishing
- **Bonus**: Increases fishing success rate and rare fish chance
- **Tools**: Fishing Rod

**15. Lumberjack (Lumberjack)**
- **Description**: Ability to harvest wood from trees
- **Primary Stat**: Strength
- **Secondary Stat**: Dexterity
- **Progression**: Gain XP by chopping trees
- **Bonus**: Increases chopping speed and rare wood chance
- **Tools**: Axe

### Crafting Skills

**16. Blacksmithing (Blacksmithing)**
- **Description**: Ability to craft weapons and metal armor
- **Primary Stat**: Strength
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by crafting blacksmithing items
- **Bonus**: Increases crafting success rate and item quality
- **Achievement**: Master Blacksmith at level 10

**17. Carpentry (Carpentry)**
- **Description**: Ability to craft wooden items and furniture
- **Primary Stat**: Dexterity
- **Secondary Stat**: Strength
- **Progression**: Gain XP by crafting carpentry items
- **Bonus**: Increases crafting success rate and item quality
- **Achievement**: Master Carpenter at level 10

**18. Tailoring (Tailoring)**
- **Description**: Ability to craft cloth armor and clothing
- **Primary Stat**: Dexterity
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by crafting tailoring items
- **Bonus**: Increases crafting success rate and item quality
- **Achievement**: Master Tailor at level 10

**19. Alchemy (Alchemy)**
- **Description**: Ability to create potions and alchemical items
- **Primary Stat**: Intelligence
- **Secondary Stat**: Luck
- **Progression**: Gain XP by crafting alchemy items
- **Bonus**: Increases crafting success rate and potion effectiveness
- **Achievement**: Master Alchemist at level 10

**20. Jewelry (Jewelry)**
- **Description**: Ability to craft rings, necklaces, and accessories
- **Primary Stat**: Dexterity
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by crafting jewelry items
- **Bonus**: Increases crafting success rate and item quality
- **Achievement**: Master Jeweler at level 10

**21. Enchantment (Enchantment)**
- **Description**: Ability to enchant items with magical properties
- **Primary Stat**: Intelligence
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by enchanting items
- **Bonus**: Increases enchantment success rate and power
- **Achievement**: Master Enchanter at level 10

**22. Cooking (Cooking)**
- **Description**: Ability to prepare food and meals
- **Primary Stat**: Intelligence
- **Secondary Stat**: Luck
- **Progression**: Gain XP by cooking food
- **Bonus**: Increases cooking success rate and food quality
- **Achievement**: Master Cook at level 10

### Special Skills

**23. Shadow Master (ShadowMaster)**
- **Description**: Mastery of shadow and stealth techniques
- **Primary Stat**: Dexterity
- **Secondary Stat**: Intelligence
- **Progression**: Gain XP by using stealth abilities
- **Bonus**: Increases stealth effectiveness and shadow abilities

**24. Animal Knowledge (AnimalKnowledge)**
- **Description**: Knowledge of animals and taming
- **Primary Stat**: Intelligence
- **Secondary Stat**: Charisma
- **Progression**: Gain XP by taming animals, interacting with pets
- **Bonus**: Improves taming success and pet effectiveness
- **Achievement**: Master Animal Knowledge at level 10

**25. Musician (Musician)**
- **Description**: Ability to play musical instruments
- **Primary Stat**: Dexterity
- **Secondary Stat**: Charisma
- **Progression**: Gain XP by playing instruments
- **Bonus**: Increases music effectiveness and buff duration

## Skill Structure

### Skill Data Structure

```typescript
interface ISkillValue {
    value: number;      // Current skill level (0-100+)
    cap: number;        // Maximum skill level (default: 100)
    experience: number; // Current experience points
}
```

### Skill Storage

**TypeScript:**
```typescript
public skills: Map<SkillName, ISkillValue> = new Map<SkillName, ISkillValue>();
```

**C#:**
```csharp
public abstract class Skill {
    public abstract string Name { get; }
    public abstract SkillGroup Group { get; }
    public abstract SkillName Type { get; }
    public virtual StatName PrimaryStat { get { return StatName.Strength; } }
    public virtual StatName SecondaryStat { get { return StatName.Dexterity; } }
    public abstract bool Useable { get; }
    public abstract void OnSkillLevelChanged(CharacterEntity character, int fromLevel, int toLevel);
}
```

## Skill Progression System

### Experience Gain

Skills gain experience through various activities:

**Combat Skills:**
- Attacking with appropriate weapons
- Successfully hitting targets
- Dealing damage

**Magic Skills:**
- Casting spells of the appropriate school
- Successfully hitting with spells
- Spell damage dealt

**Gathering Skills:**
- Successfully gathering resources
- Using appropriate tools
- Collecting rare materials

**Crafting Skills:**
- Successfully crafting items
- Crafting higher-tier items
- Crafting rare/legendary items (bonus XP)

**Social Skills:**
- Removed (Language and Diplomacy skills no longer exist)

### Experience Calculation

**Base Experience Gain:**
```typescript
public gainSkillExperiencie(skill: SkillName, gain: number = 3, saveOnDatabase: boolean = true) : void {
    let skillValue = this.getSkill(skill);
    skillValue.experience += gain;
    const tmpValue = this.getLevelFromExperience(skillValue.experience);
    const changeLevel = tmpValue !== skillValue.value;
    skillValue.value = (tmpValue <= skillValue.cap) ? tmpValue : skillValue.cap;
    this.skills.set(skill, skillValue);
}
```

**Crafting Experience:**
- **Success**: `playerSkill + bonusExp` (bonusExp = playerSkill * 3 for equipment)
- **Failure**: `playerSkill * 2 + bonusExp` (double XP for failure)
- **Insufficient Skill**: `playerSkill * 4` (quadruple XP when skill too low)

**Combat Experience:**
- Base: 3 XP per attack
- Weapon-based: Automatically gains XP for weapon skill type

**Gathering Experience:**
- Base: Varies by resource type
- Skinning: `skinnerGainExp` (creature-specific)

### Level Calculation

Skills use an experience table similar to player levels:

```typescript
public getLevelFromExperience(experience: number) : number {
    // Find level based on experience thresholds
    // Returns level with decimal precision (e.g., 5.3)
    // Level increases when experience reaches next threshold
}
```

**Level Progression:**
- Skills start at level 0
- Each level requires more experience than the previous
- Level progression becomes slower at higher levels
- Maximum level is limited by skill cap (default: 100)

### Skill Caps

**Default Cap:**
- Most skills start with cap of 100
- Caps can be increased through:
  - **Ancient Scrolls** (increase skill cap to 105, 110, 115, or 120) - See [ANCIENT_SCROLLS.md](../core/ANCIENT_SCROLLS.md)
  - Power Scrolls (increase specific skill cap) - Legacy system
  - Special items
  - Achievements

**Cap Effects:**
- Skills cannot exceed their cap
- Experience continues to accumulate but level stays at cap
- Increasing cap allows further progression
- Ancient Scrolls provide the highest cap increases (up to 120)

**Ancient Scrolls:**
- Only obtainable by defeating gods
- Party receives 6 random scrolls per god defeat
- Permanently increase skill cap beyond 100
- Can increase cap to 105, 110, 115, or 120
- Tradeable items with significant economic value
- Create competitive advantages in all skill systems

## Stat Experience Integration

### Stat Experience from Skills

When skills gain experience, they can also grant stat experience to primary and secondary stats:

**C# Implementation:**
```csharp
public void OnAddExperience(CharacterEntity character, int amount) {
    if ((character.Strength + character.Dexterity + character.Intelligence) < 150) {
        int randomChance = character.Scene.Random.Next(0, 100);
        
        // 30% chance: Primary stat gets 2x XP
        if (randomChance > 0 && randomChance <= 30) {
            switch (PrimaryStat) {
                case StatName.Strength:
                    if (character.StrengthMod == StatMod.Up)
                        character.AddStrengthExperience(amountPart * 2);
                    break;
                // ... other stats
            }
        }
        // 10% chance: Secondary stat gets 1x XP
        else if (randomChance > 30 && randomChance < 40) {
            switch (SecondaryStat) {
                // ... grant secondary stat XP
            }
        }
    }
}
```

**Stat Modifiers:**
- **StatMod.Up**: Stat is being trained (gains XP)
- **StatMod.Down**: Stat is being reduced (loses XP)
- Stats below 150 total can gain XP from skills
- Stat XP is only granted outside BattleCastle and DuelZone

**Stat Experience Loss:**
- If stat modifier is Down, stat loses XP equal to skill XP gained
- Prevents stat from going below 1

## Skill Bonuses

### Skill Bonus Calculation

```typescript
public getSkillBonus(skill: SkillName) : number {
    const skillValue = this.getSkillValue(skill);
    const modSkillValue = skillValue - 10; 
    // Returns percentage bonus (e.g., 45 for +45%)
    return (modSkillValue > 0) ? Math.floor(modSkillValue * 0.5) : 0;
}
```

**Note:** This is a simplified example. Actual implementation varies by skill type (combat skills use 0.5% per level, two-handed weapons use 0.6% per level, etc.).

**Bonus Formula (Combat Skills):**
- Skill level 0-10: No bonus
- Skill level 11-100: Bonus = (Skill Level - 10) × 0.5% per level
- Example: Level 100 skill = +45% damage bonus (with perks: +60%)
- Note: Different skills may have different scaling formulas

### Skill Bonus Applications

**Combat Skills:**
- **Damage Bonus**: Increases weapon damage
- **Accuracy Bonus**: Increases hit chance
- **Critical Chance**: May increase critical hit chance

**Magic Skills:**
- **Spell Damage**: Increases spell damage output
- **Spell Success**: Increases spell success rate
- **Mana Efficiency**: May reduce mana costs

**Gathering Skills:**
- **Speed**: Increases gathering speed
- **Success Rate**: Increases chance of successful gathering
- **Rare Materials**: Increases chance of rare material drops

**Crafting Skills:**
- **Success Rate**: Increases crafting success chance
- **Item Quality**: Improves chance of higher quality items
- **Material Efficiency**: May reduce material costs

**Formula Example (Crafting):**
```typescript
const craftChance = Math.max(
    (playerSkill >= (recipe.skillLevel + 1)) ? 100 : 
    Math.round((playerSkill * 100) / recipe.skillLevel), 
    50
);
```

## Stat Point Rewards

### Skill Level-Up Rewards

When a skill levels up, players can receive stat points:

**Reward Conditions:**
1. **Even Levels**: Every even level (2, 4, 6, 8, 10) grants 1 stat point
2. **Random Chance**: 20% chance (1 in 5) to gain 1 stat point on any level up

**Implementation:**
```typescript
if(changeLevel && tmpValue < skillValue.cap) {  
    if(Math.round(tmpValue) % 2 === 0)
        this.addStatsPoint();

    if(Random.MinMaxInt(1, 5) === 1)                  
        this.addStatsPoint();
}
```

**Total Potential Stat Points from Skills:**
- Even levels: 5 stat points (levels 2, 4, 6, 8, 10)
- Random chance: ~2 stat points average per skill
- 24 skills × ~7 stat points = ~168 potential stat points from skills
- Combined with level-up stat points (500), total potential: ~668 stat points

## Skill Progression Examples

### Combat Skill Progression

**Combat With Weapons:**
1. Player attacks with sword → Gains 3 XP
2. XP accumulates → Skill levels up
3. Skill level 4+ → Provides damage bonus
4. Even levels → Grants stat points
5. Higher levels → Better bonuses

### Crafting Skill Progression

**Blacksmithing:**
1. Player crafts iron sword → Gains XP based on skill level
2. Success → Normal XP gain
3. Failure → Double XP gain (learning from mistakes)
4. Insufficient skill → Quadruple XP gain (steep learning curve)
5. Level 100 → Maximum skill level reached (achievements unlock at level 10 for crafting skills)

### Gathering Skill Progression

**Mining:**
1. Player mines ore node → Gains XP
2. Higher skill → Faster mining
3. Higher skill → Better rare material chance
4. Level milestones → Achievement unlocks

## Skill Requirements

### Equipment Requirements

Some equipment may require minimum skill levels:
- Weapons: May require combat skill levels
- Tools: May require gathering skill levels
- Crafting stations: May require crafting skill levels

### Recipe Requirements

Crafting recipes require specific skill levels:
```typescript
if(playerSkill >= recipe.skillLevel) {
    // Can attempt crafting
}
```

**Skill Level Effects:**
- **Below Required**: Can attempt but high failure rate, quadruple XP
- **At Required**: Normal success rate, normal XP
- **Above Required**: Higher success rate, normal XP
- **Much Above**: 100% success rate, normal XP

## Skill Serialization

### TypeScript Serialization

```typescript
public serializeSkills() : string {
    let skillsParsed = [];
    
    this.skills.forEach((skill, index) => {
        skillsParsed.push({
            s: index,                    // Skill ID
            c: skill.cap,                // Cap
            v: skill.value,              // Value (level)
            p: (skill.experience === 0 && skill.value > 0) ? 
                this.getTotalExperienceForLevel(skill.value) : 
                skill.experience         // Progress (experience)
        });
    });
    
    return JSON.stringify(skillsParsed);
}
```

### Database Storage

**Player Skills:**
```json
{
    "skills": {
        "Combat With Weapons": {
            "Index": 0,
            "Cap": 100,
            "Value": 5,
            "Progress": 1250
        },
        "Mining": {
            "Index": 1,
            "Cap": 100,
            "Value": 8,
            "Progress": 3200
        }
    }
}
```

## Weapon-Skill Mapping

### Weapon Type to Skill

```typescript
public getSkillByWeapon(weaponType: WeaponType) : SkillName {
    switch(weaponType){
        case WeaponType.Axe:
        case WeaponType.Dagger:
        case WeaponType.Sword:
        case WeaponType.Hammer:
            return SkillName.CombatWithWeapons;
            
        case WeaponType.TwoHandedAxe:
        case WeaponType.TwoHandedSword:
        case WeaponType.TwoHandedHammer:
        case WeaponType.Spear:
        case WeaponType.Staff:
            return SkillName.TwoHandedWeapons;
            
        case WeaponType.Bow:
        case WeaponType.Crossbow:
            return SkillName.LongRangeWeapons;
    }
    return SkillName.None;
}
```

**Automatic Skill Gain:**
- Attacking with a weapon automatically gains XP for the corresponding skill
- `gainSkillExperiencieByWeapon()` automatically determines correct skill

## Skill Restrictions

### Zone Restrictions

Skills do not gain XP in certain zones:
- **BattleCastle**: PvP zone (no skill XP)
- **DuelZone**: Duel areas (no skill XP)

**Implementation:**
```csharp
if (character.Scene.Name != "BattleCastle" && !character.Flags.HasFlag(CreatureFlags.DuelZone)) {
    // Skill XP can be gained
}
```

## Achievements System

### Skill-Based Achievements

Skills unlock achievements at specific levels:

**Gathering Skills (Levels 5, 8, 10):**
- Mining: MINIG50, MINIG80, MINIG100
- Lumberjack: LUMBERJACK50, LUMBERJACK80, LUMBERJACK100
- Skinning: SKINNING50, SKINNING80, SKINNING100
- Herbalism: HERBALISM50, HERBALISM80, HERBALISM100

**Crafting Skills (Level 10):**
- Blacksmithing: BLACKSMITHMASTER
- Tailoring: TAILORINGMASTER
- Carpentry: CARPENTRYMASTER
- Alchemy: ALCHEMISTMASTER
- Jewelry: JEWELRYMASTER
- Animal Knowledge: ANIMALKNOWLEDGEMASTER
- Cooking: COOKINGMASTER
- Enchantment: ENCHANTMENTMASTER

**Achievement Checking:**
```typescript
public checkSkillArchivement(){
    this.steamArchivementsSkill.forEach((archivementInfo) => {
        const playerSkill = this.getSkillValue(archivementInfo.skill);
        if(playerSkill >= archivementInfo.value)
            this.setArchivement(archivementInfo.archivementName);
    });
}
```

## Rust Implementation Considerations

### Data Structures

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]
pub enum SkillName {
    None,
    CombatWithWeapons,
    LongRangeWeapons,
    TwoHandedWeapons,
    Elementarism,
    Necromancy,
    Druidy,
    Spirituality,
    MagicResistence,
    Mining,
    Herbalism,
    Skinning,
    Fishing,
    Lumberjack,
    Alchemy,
    Blacksmithing,
    Carpentry,
    Tailoring,
    Jewelry,
    Enchantment,
    Cooking,
    ShadowMaster,
    AnimalKnowledge,
    Musician,
}

pub struct SkillValue {
    pub value: f32,        // Current level (can be fractional)
    pub cap: u8,           // Maximum level
    pub experience: u64,   // Total experience
}

pub struct PlayerSkills {
    skills: HashMap<SkillName, SkillValue>,
}
```

### Skill Experience Calculation

```rust
impl PlayerSkills {
    pub fn gain_skill_experience(&mut self, skill: SkillName, gain: u32) {
        if let Some(skill_value) = self.skills.get_mut(&skill) {
            skill_value.experience += gain as u64;
            let new_level = self.calculate_level_from_experience(skill_value.experience);
            
            if new_level != skill_value.value && new_level <= skill_value.cap as f32 {
                let old_level = skill_value.value;
                skill_value.value = new_level;
                
                // Check for stat point rewards
                if (new_level as u8) % 2 == 0 {
                    // Grant stat point for even levels
                }
                
                // 20% chance for random stat point
                if thread_rng().gen_range(1..=5) == 1 {
                    // Grant stat point
                }
            }
        }
    }
    
    fn calculate_level_from_experience(&self, experience: u64) -> f32 {
        // Use experience table to calculate level
        // Returns fractional level (e.g., 5.3)
    }
    
    pub fn get_skill_bonus(&self, skill: SkillName) -> i32 {
        if let Some(skill_value) = self.skills.get(&skill) {
            let bonus = skill_value.value - 3.0;
            bonus.max(0.0) as i32
        } else {
            0
        }
    }
}
```

### Performance Optimizations

1. **Cache Skill Bonuses**: Cache calculated bonuses to avoid recalculation
2. **Batch Updates**: Process multiple skill XP gains together
3. **Lazy Evaluation**: Only calculate level when needed
4. **Lookup Tables**: Pre-calculate experience thresholds

## Integration with Other Systems

### Combat System

- Skills affect damage calculations
- Weapon skills determine which skill gains XP
- Magic skills affect spell effectiveness

### Crafting System

- Skills determine crafting success rates
- Skills unlock higher-tier recipes
- Skills affect item quality chances

### Equipment System

- Skills may be required to equip certain items
- Skill bonuses affect equipment effectiveness

### Player Progression

- Skills grant stat points on level up
- Skills contribute to overall character power
- Skills unlock new gameplay options

## Testing Strategy

### Unit Tests

- Test skill XP gain
- Test level calculation from experience
- Test skill bonus calculation
- Test stat point rewards
- Test skill caps

### Integration Tests

- Test combat skill progression
- Test crafting skill progression
- Test gathering skill progression
- Test stat XP from skills
- Test skill requirements for equipment/recipes

### Balance Tests

- Test skill progression rates
- Test skill bonus effectiveness
- Test stat point reward frequency
- Test skill cap impacts

